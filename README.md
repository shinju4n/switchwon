# 스위치원 프론트엔드 과제

실시간 환율을 조회하고 원화↔외화 환전을 수행하는 서비스

## 구현 기능

### 로그인

- 이메일 기반 로그인
- 인증되지 않은 사용자 접근 시 로그인 페이지로 리다이렉트
- 로그인 후 원래 접근하려던 페이지로 복귀

### 환전

- 실시간 환율 조회 (1분마다 자동 갱신)
- 금액 입력 시 예상 환전 금액 실시간 계산 (디바운스 적용)
- 환전 주문 요청
- 환율 변경 시 재조회 처리
- 잔액 부족 시 에러 메시지 표시 및 주문 버튼 비활성화

### 지갑

- 보유 통화별 잔액 표시 (KRW, USD, JPY)

### 환전 내역

- 거래 내역 목록 조회
- 거래 유형, 금액, 환율, 일시 표시

## 실행 방법

### 환경 변수 설정

프로덕션에서는 `.env`를 `.gitignore`에 포함되어야 하지만
평가 편의를 위해서 `.gitignore`에서 제외시켰습니다.

### 개발 서버 실행

```bash
pnpm install
pnpm dev
```

### 테스트 실행

```bash
pnpm test
```

## 기술 스택

| 분류                  | 기술                                |
| --------------------- | ----------------------------------- |
| Core                  | Next.js 16 (App Router), TypeScript |
| Package Manager       | pnpm                                |
| Styling               | Tailwind CSS, shadcn/ui             |
| State & Data Fetching | TanStack Query                      |
| Form & Validation     | React Hook Form, Zod                |
| Testing               | Jest, React Testing Library         |
| ETC                   | Prettier, Husky, lint-staged        |

## 폴더 구조

```
├── app/
│   ├── (auth)/login/          # 로그인 페이지
│   │   ├── _api/              # 로그인 API
│   │   ├── _components/       # 로그인 폼, 히어로
│   │   ├── _hooks/            # useLogin
│   │   ├── _schema/           # Zod 스키마
│   │   └── page.tsx
│   │
│   ├── (main)/                # 인증 필요 영역
│   │   ├── exchange/          # 환전 페이지
│   │   │   ├── _api/          # 환율, 주문, 지갑 API
│   │   │   ├── _components/   # 환전 폼, 통화 대시보드
│   │   │   ├── _hooks/        # useOrder, useQuote, useWallet
│   │   │   ├── _utils/        # 통화 관련 유틸
│   │   │   └── page.tsx
│   │   │
│   │   └── exchange-history/  # 거래 내역 페이지
│   │
│   ├── api/
│   │   ├── auth/              # 로그인/로그아웃 (쿠키 설정)
│   │   └── proxy/[...path]/   # BFF 프록시
│   │
│   └── provider.tsx           # QueryClient Provider
│
├── components/ui/             # shadcn/ui 컴포넌트
├── constants/                 # 상수 (경로, 쿼리키)
├── lib/                       # API 유틸, cn 함수
└── types/                     # 공통 타입

```

**폴더 네이밍 규칙:**

- `_api`, `_hooks`, `_components`: 해당 페이지 전용 (라우팅에서 제외)
- `(auth)`, `(main)`: Route Group

## 의사 결정

### 1. 토큰 저장 방식

초기에 토큰 저장 방식에 대해서 고민했습니다.

- LocalStorage
- Cookie (httpOnly)

LocalStorage에 저장하는 방식은 구현이 간단하지만 XSS 공격 취약 및 SSR 활용이 불가하기 떄문에 Cookie에 토큰을 선택하는 방식을 채택했습니다.

### 2. CORS 및 httpOnly 쿠키 제약 해결

쿠키 방식을 선택한 후, 실제 API를 호출하는 과정에서 백엔드 규격과 충돌하는 문제가 발생했습니다.

문제 상황: 백엔드 API는 모든 요청 헤더에 Authorization: Bearer {token}을 요구합니다. 하지만 httpOnly 쿠키는 보안상 클라이언트 코드(JS)에서 값을 꺼낼 수 없기 때문에, 브라우저가 직접 헤더에 토큰을 담아 보낼 방법이 없었습니다. 게다가 백엔드 서버에 CORS가 설정되어 있지 않아 브라우저에서의 직접 호출 자체가 차단된 상태였습니다.

해결 모색:

1. 처음에는 `next.config.js`의 `rewrites` 기능을 검토했습니다. 하지만 `rewrites`는 단순한 주소 연결일 뿐, 서버에 저장된 쿠키를 읽어 헤더에 토큰을 동적으로 주입하는 로직을 담을 수 없다는 한계가 있었습니다.
2. 따라서 단순 포워딩이 아닌, 직접 요청을 가로채서 가공할 수 있는 `BFF(Backend For Frontend)` 방식을 채택했습니다.

최종 해결: `app/api/proxy/[...path]` 경로에 Catch-all Route를 구현했습니다.

1. 클라이언트가 프록시 경로로 API를 요청하면 Next.js 서버가 이를 수신합니다.
2. 서버는 쿠키에서 토큰을 꺼내 헤더에 주입합니다.
3. 서버 대 서버 통신을 통해 CORS 문제를 우회하며 백엔드에 데이터를 요청하고 응답 값 그대로 클라이언트에 전달합니다.

이 구조를 통해 보안(쿠키)과 백엔드 요구 규격(헤더 토큰) 사이의 간극을 해결했습니다.

### 3. SSR 환경에서의 API 호출 문제 해결

Server Component에서 BFF 프록시를 호출할 때 발생한 문제들을 다음과 같이 해결했습니다.

**3-1. 서버에서의 API 주소 인식 문제**

문제: 브라우저와 달리 서버(Node.js)는 `/api/proxy/...` 같은 상대 경로가 어디를 가리키는지 알지 못해 에러가 발생했습니다.

해결: 서버에서 실행될 때는 `NEXT_PUBLIC_SITE_URL` 환경 변수를 사용하여 절대 경로를 구성하도록 유틸리티 함수를 만들어 해결했습니다.

**3-2. 서버에서 API 호출 시 쿠키 전달 문제**

문제: Server Component에서 프록시 API를 호출할 때, 브라우저로부터 받은 쿠키가 내부 fetch 요청에 자동으로 포함되지 않았습니다.

해결: `next/headers`를 사용해 원본 요청의 쿠키를 읽고, fetch 헤더에 수동으로 주입하여 해결했습니다.

### 4. 환율 변경 시 재조회 처리

문제: 환전 주문 시 환율이 이미 변경되었을 경우 `EXCHANGE_RATE_MISMATCH` 에러가 발생합니다.

해결: 해당 에러 발생 시 환율 캐시를 무효화하여 최신 환율을 자동으로 다시 조회하도록 구현했습니다. 사용자는 별도 조작 없이 갱신된 환율로 다시 시도할 수 있습니다.

### 5. Open Redirect 방지

문제: 로그인 후 `?redirect=` 파라미터로 리다이렉트할 때, 외부 URL로의 리다이렉트가 가능하면 피싱 공격에 악용될 수 있습니다.

해결: 리다이렉트 경로가 `/`로 시작하고 `//`로 시작하지 않는 경우(상대 경로)만 허용하도록 검증 로직을 추가했습니다.

### 6. 환경 변수 검증

문제: SSR 환경에서 `NEXT_PUBLIC_SITE_URL`이 설정되지 않으면 API 호출이 실패합니다. 하지만 환경 변수 누락은 런타임에서야 발견되어 디버깅이 어려웠습니다.

해결: 두 단계로 검증을 추가했습니다.

1. **빌드 타임 검증**: `next.config.ts`에서 프로덕션 빌드 시 필수 환경 변수가 없으면 빌드 자체를 실패시킵니다.
2. **런타임 검증**: `getBaseUrl()` 함수에서 환경 변수가 없으면 명시적인 에러를 throw합니다.

이를 통해 배포 전에 설정 오류를 조기에 발견할 수 있습니다.

## 추가 개선

명세에는 정의되지 않았으나, 사용자 경험 향상을 위해 자체적으로 추가한 항목입니다.

### 거래 내역 통화 단위 표시

금액만으로는 KRW/USD/JPY를 구분할 수 없어 통화 기호를 추가로 표시했습니다.

### 최대 환전 금액 자동 계산

보유 잔액 내에서 최대로 환전할 수 있는 금액을 한 번에 입력할 수 있도록 기능을 추가했습니다.
매수 시에는 KRW 잔액을 현재 환율로 나누어 최대 외화 수량을 계산하고,
매도 시에는 보유 외화 잔액을 그대로 입력합니다.

### 잔액 부족 검증

환전 금액이 보유 잔액을 초과할 경우 에러 메시지를 표시하고 주문 버튼을 비활성화합니다.
매수 시에는 필요한 KRW 금액과 보유 KRW 잔액을 비교하고,
매도 시에는 입력한 외화 금액과 보유 외화 잔액을 비교합니다.

## 테스트

안정성을 위해 AI를 활용하여
Jest와 React Testing Library를 사용하여 테스트를 작성했습니다.

```bash
pnpm test
```

### 테스트 범위

| 파일                      | 테스트 내용                                              |
| ------------------------- | -------------------------------------------------------- |
| `currency.test.ts`        | 통화 정렬, 통화쌍 반환 로직                              |
| `useOrder.test.ts`        | 주문 성공/실패, 캐시 무효화, EXCHANGE_RATE_MISMATCH 처리 |
| `useLogin.test.ts`        | 로그인 성공/실패, 리다이렉트, Open Redirect 방지         |
| `useExchangeForm.test.ts` | 최대 금액 계산, 잔액 검증, 주문 파라미터 검증            |

Hook 테스트는 `jest.mock()`으로 API를 모킹하여 외부 의존성 없이 로직만 검증했습니다.
